# 10.2 - Configuration de DynamoDB Local avec IP fixe

üîù Retour au [Sommaire](/SOMMAIRE.md)

---

## üìã Introduction

Dans la fiche pr√©c√©dente, nous avons configur√© DynamoDB Local de mani√®re basique. Le conteneur obtient automatiquement une adresse IP attribu√©e par Docker.

**Pourquoi vouloir une IP fixe ?**

Imaginez que vous d√©veloppez une application web avec plusieurs conteneurs Docker :
- üóÑÔ∏è Un conteneur pour DynamoDB Local
- üåê Un conteneur pour votre API (Node.js, Python, etc.)
- üñ•Ô∏è Un conteneur pour votre frontend (React, Angular, etc.)

**Le probl√®me :** √Ä chaque red√©marrage, Docker peut changer l'adresse IP de vos conteneurs. Votre API ne sait plus o√π trouver la base de donn√©es !

**La solution :** Assigner une **adresse IP fixe** √† votre conteneur DynamoDB. Comme √ßa, peu importe combien de fois vous red√©marrez, l'IP reste toujours la m√™me.

**Ce que vous allez apprendre :**
- Cr√©er un r√©seau Docker personnalis√©
- Attribuer une IP fixe √† DynamoDB Local
- Faire communiquer plusieurs conteneurs entre eux
- Comprendre les r√©seaux Docker

---

## üéØ Pr√©requis

‚úÖ Avoir lu la [fiche 10.1 - Configuration basique](01-config-basique-docker-compose.md)
‚úÖ Docker et Docker Compose install√©s
‚úÖ Comprendre les bases de Docker
‚úÖ 10 minutes de votre temps ‚è±Ô∏è

---

## üåê Comprendre les r√©seaux Docker

### Sans r√©seau personnalis√© (configuration basique)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     R√©seau par d√©faut (bridge)      ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  DynamoDB                   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  IP: 172.17.0.2 (al√©atoire) ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Probl√®me :** L'IP `172.17.0.2` peut changer au prochain red√©marrage.

### Avec r√©seau personnalis√© (ce qu'on va faire)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   R√©seau dynamodb_net (172.18.0.0/16) ‚îÇ
‚îÇ                                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ  DynamoDB                ‚îÇ         ‚îÇ
‚îÇ  ‚îÇ  IP: 172.18.0.10 (FIXE!) ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Avantage :** L'IP `172.18.0.10` ne change **jamais** !

---

## üöÄ √âtape 1 : Cr√©ation du r√©seau Docker

Avant de cr√©er notre fichier `docker-compose.yml`, nous devons cr√©er un **r√©seau personnalis√©** avec une plage d'adresses IP d√©finie.

### Cr√©er le r√©seau

Ouvrez votre terminal et ex√©cutez cette commande **une seule fois** :

```bash
docker network create --subnet=172.18.0.0/16 dynamodb_net
```

**Explication de la commande :**
- `docker network create` : Cr√©e un nouveau r√©seau Docker
- `--subnet=172.18.0.0/16` : D√©finit la plage d'adresses IP disponibles
  - `172.18.0.0/16` signifie : de `172.18.0.1` √† `172.18.255.254`
- `dynamodb_net` : Nom de notre r√©seau personnalis√©

**Sortie attendue :**
```
abc123def456...
```

C'est l'identifiant unique de votre r√©seau.

### V√©rifier le r√©seau

```bash
docker network ls
```

**Sortie :**
```
NETWORK ID     NAME            DRIVER    SCOPE
abc123def456   dynamodb_net    bridge    local
...
```

Vous devez voir votre r√©seau `dynamodb_net` dans la liste.

### Inspecter le r√©seau

Pour voir les d√©tails de votre r√©seau :

```bash
docker network inspect dynamodb_net
```

Vous verrez notamment :
```json
"Subnet": "172.18.0.0/16"
```

---

## üìù √âtape 2 : Configuration avec docker-compose

### A. Cr√©er le dossier du projet

```bash
# Cr√©er et entrer dans le dossier
mkdir dynamodb-ip-fixe
cd dynamodb-ip-fixe
```

### B. Cr√©er le fichier docker-compose.yml

Cr√©ez un fichier `docker-compose.yml` avec ce contenu :

```yaml
version: '3.8'

services:
  dynamodb:
    image: amazon/dynamodb-local:latest
    container_name: dynamodb_ip_fixe
    restart: unless-stopped

    ports:
      - "8000:8000"

    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /data"

    volumes:
      - dynamodb_data:/data

    # Configuration r√©seau avec IP fixe
    networks:
      dynamodb_net:
        ipv4_address: 172.18.0.10

# D√©claration du volume
volumes:
  dynamodb_data:
    driver: local

# D√©claration du r√©seau (EXTERNE car cr√©√© manuellement)
networks:
  dynamodb_net:
    external: true
```

---

## üîç Comprendre les modifications

Comparons avec la configuration basique :

### üÜï Nouvelle section : `networks` dans le service

```yaml
networks:
  dynamodb_net:
    ipv4_address: 172.18.0.10
```

**Explication :**
- `dynamodb_net` : Utilise le r√©seau que nous avons cr√©√©
- `ipv4_address: 172.18.0.10` : **Fixe** l'IP √† `172.18.0.10`

**Pourquoi `.10` ?** Convention personnelle. Vous pourriez choisir :
- `172.18.0.5`
- `172.18.0.100`
- N'importe quelle IP dans la plage `172.18.0.1` √† `172.18.255.254`

### üÜï D√©claration du r√©seau global

```yaml
networks:
  dynamodb_net:
    external: true
```

**Explication :**
- `external: true` : Indique √† Docker Compose que le r√©seau existe **d√©j√†**
- Docker Compose ne tentera **pas** de cr√©er ce r√©seau (il a d√©j√† √©t√© cr√©√© manuellement)

---

## ‚ñ∂Ô∏è √âtape 3 : D√©marrer DynamoDB avec IP fixe

Dans le dossier contenant votre `docker-compose.yml` :

```bash
docker-compose up -d
```

**Sortie attendue :**
```
Creating volume "dynamodb-ip-fixe_dynamodb_data" with local driver
Creating dynamodb_ip_fixe ... done
```

‚úÖ DynamoDB Local d√©marre maintenant avec l'IP **172.18.0.10** !

---

## ‚úÖ √âtape 4 : V√©rifier l'IP fixe

### M√©thode 1 : Inspection du conteneur

```bash
docker inspect dynamodb_ip_fixe | grep "IPAddress"
```

**Sortie attendue :**
```
"IPAddress": "",
"IPAddress": "172.18.0.10",
```

Vous devez voir `172.18.0.10` !

### M√©thode 2 : Inspection compl√®te du r√©seau

```bash
docker network inspect dynamodb_net
```

Dans la section `"Containers"`, vous verrez :

```json
"Containers": {
    "abc123...": {
        "Name": "dynamodb_ip_fixe",
        "IPv4Address": "172.18.0.10/16",
        ...
    }
}
```

### M√©thode 3 : Test de connectivit√©

```bash
# Depuis votre PC (via localhost)
curl http://localhost:8000/shell

# Depuis l'IP fixe
curl http://172.18.0.10:8000/shell
```

Les deux doivent fonctionner !

---

## üîó √âtape 5 : Connexion depuis un autre conteneur

Maintenant que DynamoDB a une IP fixe, d'autres conteneurs peuvent s'y connecter facilement.

### Exemple : Conteneur Node.js qui se connecte √† DynamoDB

Cr√©ez un fichier `docker-compose.yml` complet avec deux services :

```yaml
version: '3.8'

services:
  # Service DynamoDB
  dynamodb:
    image: amazon/dynamodb-local:latest
    container_name: dynamodb_ip_fixe
    restart: unless-stopped
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /data"
    volumes:
      - dynamodb_data:/data
    networks:
      dynamodb_net:
        ipv4_address: 172.18.0.10

  # Service d'exemple : Application Node.js
  app:
    image: node:18-alpine
    container_name: app_nodejs
    restart: unless-stopped

    # Variables d'environnement pour la connexion
    environment:
      DYNAMODB_ENDPOINT: "http://172.18.0.10:8000"
      AWS_REGION: "us-east-1"
      AWS_ACCESS_KEY_ID: "fakeKey"
      AWS_SECRET_ACCESS_KEY: "fakeSecret"

    # Connect√© au m√™me r√©seau
    networks:
      - dynamodb_net

    # Commande qui maintient le conteneur actif
    command: tail -f /dev/null

volumes:
  dynamodb_data:

networks:
  dynamodb_net:
    external: true
```

**Points cl√©s :**
- L'application utilise `DYNAMODB_ENDPOINT: "http://172.18.0.10:8000"`
- L'IP **172.18.0.10** est fixe et ne changera jamais
- Les deux conteneurs sont sur le m√™me r√©seau `dynamodb_net`

### Tester la connexion

```bash
# D√©marrer les deux services
docker-compose up -d

# Entrer dans le conteneur Node.js
docker exec -it app_nodejs sh

# Installer AWS SDK (dans le conteneur)
npm install -g aws-sdk

# Test de connexion (dans le conteneur)
node
> const AWS = require('aws-sdk');
> const dynamodb = new AWS.DynamoDB({
...   endpoint: 'http://172.18.0.10:8000',
...   region: 'us-east-1'
... });
> dynamodb.listTables({}, (err, data) => {
...   if (err) console.error(err);
...   else console.log('Connexion OK:', data);
... });
```

Si vous voyez `Connexion OK:`, tout fonctionne ! üéâ

---

## üåç Acc√®s depuis votre machine h√¥te

Votre PC (la machine h√¥te) peut acc√©der √† DynamoDB de **deux fa√ßons** :

### 1. Via localhost (recommand√©)

```javascript
// Dans votre code sur votre PC
const dynamodb = new AWS.DynamoDB({
  endpoint: 'http://localhost:8000',
  region: 'us-east-1'
});
```

**Fonctionne car :** Le port 8000 du conteneur est mapp√© sur le port 8000 de votre PC.

### 2. Via l'IP fixe

```javascript
// Dans votre code sur votre PC
const dynamodb = new AWS.DynamoDB({
  endpoint: 'http://172.18.0.10:8000',
  region: 'us-east-1'
});
```

**Fonctionne car :** Votre PC peut acc√©der aux r√©seaux Docker bridge.

**‚ö†Ô∏è Attention :** La m√©thode via IP fixe peut ne pas fonctionner sur tous les syst√®mes (notamment Docker Desktop sur macOS/Windows avec certaines versions).

**Recommandation :** Utilisez `localhost` depuis votre PC, et l'IP fixe uniquement pour la communication entre conteneurs.

---

## üõ†Ô∏è Commandes utiles

### Voir les conteneurs sur le r√©seau

```bash
docker network inspect dynamodb_net | grep -A 5 "Containers"
```

### Tester la connectivit√© entre conteneurs

```bash
# Depuis le conteneur app_nodejs, pingez DynamoDB
docker exec app_nodejs ping -c 3 172.18.0.10
```

**Sortie attendue :**
```
PING 172.18.0.10 (172.18.0.10): 56 data bytes
64 bytes from 172.18.0.10: seq=0 ttl=64 time=0.123 ms
...
```

### Lister les r√©seaux Docker

```bash
docker network ls
```

### Voir tous les conteneurs d'un r√©seau

```bash
docker network inspect dynamodb_net --format '{{range .Containers}}{{.Name}}: {{.IPv4Address}}{{println}}{{end}}'
```

---

## üßπ √âtape 6 : Suppression compl√®te

### 1. Arr√™ter et supprimer les conteneurs

```bash
docker-compose down
```

### 2. Supprimer le volume (ATTENTION : supprime les donn√©es)

```bash
docker volume rm dynamodb-ip-fixe_dynamodb_data
```

ou

```bash
docker volume prune
```

### 3. Supprimer le r√©seau Docker

**Important :** Comme le r√©seau a √©t√© cr√©√© **manuellement** et est marqu√© comme `external: true`, Docker Compose ne le supprime **pas** automatiquement.

Vous devez le supprimer vous-m√™me :

```bash
docker network rm dynamodb_net
```

**V√©rification :**
```bash
docker network ls | grep dynamodb
```

Ne doit rien retourner.

---

## üìä Comparaison : Avec vs Sans IP fixe

| Crit√®re | Sans IP fixe | Avec IP fixe |
|---------|--------------|--------------|
| **Configuration** | Simple | L√©g√®rement plus complexe |
| **IP du conteneur** | Al√©atoire (change) | Fixe (ne change jamais) |
| **Communication inter-conteneurs** | Par nom de service | Par IP ou nom |
| **Pr√©visibilit√©** | ‚ùå Faible | ‚úÖ Forte |
| **Cas d'usage** | Dev simple | Multi-conteneurs, microservices |
| **Nettoyage** | Automatique | Manuel (r√©seau externe) |

---

## üéì Concepts cl√©s √† retenir

### üåê Qu'est-ce qu'un r√©seau Docker ?

Un **r√©seau Docker** est comme un "r√©seau local virtuel" pour vos conteneurs :
- Les conteneurs peuvent communiquer entre eux
- Isolation par rapport √† d'autres r√©seaux
- Contr√¥le des adresses IP

### üìç Subnet (sous-r√©seau)

`172.18.0.0/16` signifie :
- **172.18** : Pr√©fixe fixe
- **0.0** √† **255.255** : Plage disponible
- `/16` : Nombre de bits du pr√©fixe r√©seau

**Exemple de plage :**
- IP r√©seau : `172.18.0.0`
- Premi√®re IP utilisable : `172.18.0.1`
- Derni√®re IP utilisable : `172.18.255.254`
- Broadcast : `172.18.255.255`

### üîí R√©seau `external: true`

Quand vous marquez un r√©seau comme `external: true` :
- Docker Compose **n'essaie pas** de le cr√©er
- Vous devez le cr√©er manuellement **avant** le `docker-compose up`
- Docker Compose **ne le supprime pas** lors du `docker-compose down`

---

## ‚ùì Probl√®mes courants

### Erreur : "network dynamodb_net not found"

**Cause :** Le r√©seau n'a pas √©t√© cr√©√© avant le `docker-compose up`.

**Solution :**
```bash
docker network create --subnet=172.18.0.0/16 dynamodb_net
docker-compose up -d
```

### Erreur : "address already in use"

**Cause :** L'IP `172.18.0.10` est d√©j√† utilis√©e par un autre conteneur.

**Solution 1 :** Stoppez l'autre conteneur :
```bash
docker ps
docker stop <nom_conteneur_utilisant_cette_ip>
```

**Solution 2 :** Changez l'IP dans votre `docker-compose.yml` :
```yaml
ipv4_address: 172.18.0.11  # Au lieu de .10
```

### Le conteneur ne d√©marre pas

**Diagnostic :**
```bash
docker-compose logs dynamodb
```

**V√©rifications :**
1. Le r√©seau existe bien : `docker network ls`
2. L'IP est dans la plage : `172.18.0.0/16`
3. Pas de conflit avec d'autres conteneurs

---

## üí° Bonnes pratiques

### 1. Conventions de nommage

Utilisez des noms coh√©rents pour vos r√©seaux :
```bash
# Mauvais
docker network create mynet

# Bon
docker network create app_backend_net
```

### 2. Plages d'IP personnalis√©es

√âvitez les plages communes :
- ‚ùå `172.17.0.0/16` (r√©seau Docker par d√©faut)
- ‚úÖ `172.18.0.0/16`, `172.19.0.0/16`, `10.5.0.0/16`

### 3. Documentation

Documentez vos IP fixes dans un fichier `NETWORK.md` :

```markdown
## R√©seaux Docker

### dynamodb_net (172.18.0.0/16)
- 172.18.0.10 : DynamoDB Local
- 172.18.0.20 : Application backend
- 172.18.0.30 : Redis cache
```

### 4. √âvitez les IP tr√®s basses

R√©servez les premi√®res IP pour Docker :
- ‚ùå `172.18.0.1`, `172.18.0.2`
- ‚úÖ √Ä partir de `172.18.0.10`

---

## üéØ Cas d'usage pratiques

### Microservices

```yaml
services:
  dynamodb:
    networks:
      app_net:
        ipv4_address: 172.18.0.10

  api-users:
    networks:
      app_net:
        ipv4_address: 172.18.0.20

  api-products:
    networks:
      app_net:
        ipv4_address: 172.18.0.30
```

### Tests d'int√©gration

Les tests peuvent utiliser `http://172.18.0.10:8000` pour des connexions pr√©visibles.

### Monitoring

Un conteneur de monitoring (Prometheus, Grafana) peut scraper `172.18.0.10:8000/metrics`.

---

## üéØ Prochaines √©tapes

Maintenant que vous ma√Ætrisez les IP fixes, explorez :

1. **[DynamoDB avec Admin UI](03-dynamodb-admin-ui.md)** - Interface graphique pour g√©rer vos tables
2. **[Utilisation avec AWS CLI](04-utilisation-aws-cli.md)** - Cr√©er et manipuler des tables
3. **[Annexe B - Gestion des r√©seaux](../annexes/B-gestion-reseaux.md)** - R√©seaux Docker avanc√©s

---

## üìö Ressources compl√©mentaires

- üåê [Docker Networks Documentation](https://docs.docker.com/network/)
- üîß [Bridge Networks](https://docs.docker.com/network/bridge/)
- üìñ [Docker Compose Networking](https://docs.docker.com/compose/networking/)

---

## ‚úÖ Checklist de fin

Avant de passer √† la fiche suivante, v√©rifiez que vous savez :

- [ ] Cr√©er un r√©seau Docker avec `docker network create`
- [ ] Configurer une IP fixe dans `docker-compose.yml`
- [ ] Comprendre `external: true` pour les r√©seaux
- [ ] V√©rifier l'IP d'un conteneur avec `docker inspect`
- [ ] Faire communiquer deux conteneurs via IP fixe
- [ ] Supprimer un r√©seau Docker manuellement

---

üîù Retour au [Sommaire](/SOMMAIRE.md)
‚¨ÖÔ∏è Fiche pr√©c√©dente : [10.1 - Configuration basique](01-config-basique-docker-compose.md)
‚û°Ô∏è Fiche suivante : [10.3 - DynamoDB avec Admin UI](03-dynamodb-admin-ui.md)

---

*Derni√®re mise √† jour : Novembre 2025*
