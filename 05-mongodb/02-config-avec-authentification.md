# 5.2 - Configuration de MongoDB avec authentification

üîù Retour au [Sommaire](/SOMMAIRE.md)

---

## üìã Introduction

Dans la [fiche pr√©c√©dente (5.1)](01-config-basique-docker-compose.md), nous avons mis en place MongoDB sans authentification. C'√©tait parfait pour d√©buter, mais **tr√®s peu s√©curis√©** : n'importe qui peut acc√©der √† vos donn√©es !

Dans cette fiche, nous allons **activer l'authentification** pour prot√©ger votre base de donn√©es. Cela signifie que vous devrez fournir un nom d'utilisateur et un mot de passe pour vous connecter.

### üîê Pourquoi activer l'authentification ?

**Sans authentification :**
- ‚ùå Toute personne ayant acc√®s au port peut lire/modifier/supprimer vos donn√©es
- ‚ùå Impossible d'utiliser sur un r√©seau partag√©
- ‚ùå Non conforme aux bonnes pratiques de s√©curit√©

**Avec authentification :**
- ‚úÖ Seuls les utilisateurs autoris√©s peuvent acc√©der aux donn√©es
- ‚úÖ Vous pouvez cr√©er plusieurs utilisateurs avec diff√©rents niveaux de permissions
- ‚úÖ Approche plus proche d'un environnement de production

---

## üéØ Objectifs de cette fiche

√Ä la fin de ce tutoriel, vous saurez :

- ‚úÖ Activer l'authentification sur MongoDB
- ‚úÖ Cr√©er un utilisateur administrateur
- ‚úÖ Cr√©er des utilisateurs avec des permissions sp√©cifiques
- ‚úÖ Vous connecter √† MongoDB avec authentification (shell et client GUI)
- ‚úÖ G√©rer les utilisateurs et leurs droits

---

## üõ†Ô∏è Pr√©requis

Avant de commencer :

- **Docker** et **Docker Compose** install√©s
- Avoir suivi la [fiche 5.1](01-config-basique-docker-compose.md) ou comprendre les bases de Docker Compose
- Un √©diteur de texte

---

## üìÅ √âtape 1 : Pr√©paration de l'environnement

### A. Cr√©er un nouveau dossier de projet

```bash
# Cr√©er le dossier
mkdir mongodb_avec_auth

# Se d√©placer dedans
cd mongodb_avec_auth

# Cr√©er le dossier pour les donn√©es
mkdir data
```

Votre structure :

```
mongodb_avec_auth/
‚îî‚îÄ‚îÄ data/          (vide pour l'instant)
```

---

## üìÑ √âtape 2 : Cr√©ation du fichier `docker-compose.yml`

Cr√©ez un fichier **`docker-compose.yml`** avec le contenu suivant :

```yaml
version: '3.8'

services:
  mongodb:
    # Image officielle MongoDB (version 7.0)
    image: mongo:7.0

    # Nom du conteneur
    container_name: mongodb_secure

    # Red√©marre automatiquement
    restart: unless-stopped

    # Variables d'environnement pour cr√©er l'utilisateur root
    environment:
      # Nom d'utilisateur de l'administrateur principal
      MONGO_INITDB_ROOT_USERNAME: admin

      # ‚ö†Ô∏è CHANGEZ CE MOT DE PASSE ‚ö†Ô∏è
      # Utilisez un mot de passe fort (lettres, chiffres, symboles)
      MONGO_INITDB_ROOT_PASSWORD: motdepasse_securise_123

      # Base de donn√©es par d√©faut (optionnel)
      MONGO_INITDB_DATABASE: admin

    # Port pour acc√©der √† MongoDB
    ports:
      - "27017:27017"

    # Volume pour la persistance des donn√©es
    volumes:
      - ./data:/data/db
```

### üìñ Explication des nouveaut√©s

| √âl√©ment | Signification |
|---------|---------------|
| `environment:` | Variables d'environnement pour configurer MongoDB |
| `MONGO_INITDB_ROOT_USERNAME` | Nom de l'utilisateur administrateur cr√©√© au premier d√©marrage |
| `MONGO_INITDB_ROOT_PASSWORD` | Mot de passe de cet administrateur |
| `MONGO_INITDB_DATABASE` | Base de donn√©es initiale (g√©n√©ralement `admin`) |

### üîí Important : S√©curit√© des mots de passe

**‚ö†Ô∏è NE JAMAIS utiliser des mots de passe simples comme :**
- `password`
- `123456`
- `admin`
- `mongodb`

**‚úÖ Utilisez des mots de passe forts :**
- Au moins 12 caract√®res
- M√©lange de lettres (majuscules et minuscules)
- Chiffres
- Symboles (`!@#$%^&*`)

**Exemple de bon mot de passe :** `Mdb$2024!SecurePass#`

---

## ‚ñ∂Ô∏è √âtape 3 : D√©marrage de MongoDB avec authentification

Lancez MongoDB :

```bash
docker-compose up -d
```

**Sortie attendue :**

```
Creating network "mongodb_avec_auth_default" with the default driver
Creating mongodb_secure ... done
```

### ‚úÖ V√©rification du d√©marrage

```bash
docker-compose ps
```

R√©sultat attendu :

```
     Name                   Command             State            Ports
--------------------------------------------------------------------------------
mongodb_secure   docker-entrypoint.sh mongod   Up      0.0.0.0:27017->27017/tcp
```

### üîç V√©rification dans les logs

Pour confirmer que l'authentification est activ√©e :

```bash
docker-compose logs mongodb | grep -i auth
```

Vous devriez voir des messages mentionnant l'authentification.

---

## üîë √âtape 4 : Connexion avec authentification

### A. Depuis le shell MongoDB

Maintenant que l'authentification est activ√©e, vous **devez** fournir les identifiants pour vous connecter.

**M√©thode 1 : Connexion directe avec identifiants**

```bash
docker exec -it mongodb_secure mongosh -u admin -p motdepasse_securise_123 --authenticationDatabase admin
```

**Explication des param√®tres :**
- `-u admin` : Nom d'utilisateur
- `-p motdepasse_securise_123` : Mot de passe
- `--authenticationDatabase admin` : Base de donn√©es contenant les informations d'authentification

**M√©thode 2 : Connexion puis authentification**

```bash
# Se connecter sans authentification
docker exec -it mongodb_secure mongosh

# Une fois dans le shell, s'authentifier
use admin
db.auth("admin", "motdepasse_securise_123")
```

**R√©sultat attendu :**

```javascript
{ ok: 1 }
```

Si vous voyez `{ ok: 1 }`, vous √™tes connect√© avec succ√®s ! üéâ

### B. Depuis MongoDB Compass (client graphique)

**Param√®tres de connexion :**

| Param√®tre | Valeur |
|-----------|--------|
| **Type de connexion** | URI |
| **URI compl√®te** | `mongodb://admin:motdepasse_securise_123@localhost:27017/?authSource=admin` |

**Ou en mode formulaire :**

| Champ | Valeur |
|-------|--------|
| **H√¥te** | `localhost` |
| **Port** | `27017` |
| **Username** | `admin` |
| **Password** | `motdepasse_securise_123` |
| **Authentication Database** | `admin` |
| **Authentication Method** | Username/Password |

---

## üë• √âtape 5 : Cr√©er des utilisateurs suppl√©mentaires

L'utilisateur `admin` a tous les droits. Pour plus de s√©curit√©, cr√©ez des utilisateurs avec des permissions limit√©es pour vos applications.

### A. Cr√©er un utilisateur pour une base de donn√©es sp√©cifique

Connectez-vous avec l'utilisateur `admin` :

```bash
docker exec -it mongodb_secure mongosh -u admin -p motdepasse_securise_123 --authenticationDatabase admin
```

**Cr√©er une base de donn√©es et un utilisateur :**

```javascript
// 1. Cr√©er/utiliser une base de donn√©es "mabase"
use mabase

// 2. Cr√©er un utilisateur avec droits de lecture/√©criture uniquement sur "mabase"
db.createUser({
  user: "user_mabase",
  pwd: "password_user_123",
  roles: [
    { role: "readWrite", db: "mabase" }
  ]
})
```

**R√©sultat attendu :**

```javascript
{ ok: 1 }
```

**Explications :**

| √âl√©ment | Signification |
|---------|---------------|
| `user: "user_mabase"` | Nom du nouvel utilisateur |
| `pwd: "password_user_123"` | Mot de passe (√† changer !) |
| `role: "readWrite"` | Peut lire et √©crire dans la base |
| `db: "mabase"` | Uniquement sur la base "mabase" |

### B. Tester le nouvel utilisateur

**Quittez le shell actuel :**

```javascript
exit
```

**Reconnectez-vous avec le nouvel utilisateur :**

```bash
docker exec -it mongodb_secure mongosh -u user_mabase -p password_user_123 --authenticationDatabase mabase
```

**Testez les permissions :**

```javascript
// S√©lectionner la base "mabase" (fonctionne)
use mabase

// Ins√©rer un document (fonctionne)
db.test.insertOne({ nom: "Test", valeur: 42 })

// Lire les documents (fonctionne)
db.test.find()

// Essayer d'acc√©der √† une autre base (ne fonctionne pas)
use admin
show collections  // ‚ùå Erreur : pas de permissions
```

Vous verrez une erreur de permissions : c'est normal ! Cet utilisateur n'a acc√®s qu'√† `mabase`.

---

## üõ°Ô∏è √âtape 6 : Comprendre les r√¥les MongoDB

MongoDB propose plusieurs r√¥les pr√©d√©finis avec diff√©rents niveaux de permissions :

### R√¥les principaux

| R√¥le | Permissions | Utilisation |
|------|-------------|-------------|
| `read` | Lecture seule | Utilisateurs qui consultent les donn√©es |
| `readWrite` | Lecture et √©criture | Applications standards |
| `dbAdmin` | Administration de la base | Gestion des index, statistiques |
| `userAdmin` | Gestion des utilisateurs | Cr√©er/modifier des utilisateurs |
| `dbOwner` | Tous les droits sur la base | Propri√©taire de la base |
| `readAnyDatabase` | Lecture sur toutes les bases | Monitoring |
| `readWriteAnyDatabase` | Lecture/√©criture sur toutes les bases | Applications multi-bases |
| `userAdminAnyDatabase` | Gestion des users sur toutes les bases | Administration |
| `dbAdminAnyDatabase` | Administration de toutes les bases | DBA |
| `root` | **TOUS LES DROITS** | Super-administrateur |

### Exemples de cr√©ation d'utilisateurs avec diff√©rents r√¥les

**Utilisateur en lecture seule :**

```javascript
use mabase
db.createUser({
  user: "lecteur",
  pwd: "motdepasse_lecteur",
  roles: [
    { role: "read", db: "mabase" }
  ]
})
```

**Utilisateur avec plusieurs r√¥les :**

```javascript
use mabase
db.createUser({
  user: "admin_mabase",
  pwd: "motdepasse_admin_mabase",
  roles: [
    { role: "readWrite", db: "mabase" },
    { role: "dbAdmin", db: "mabase" }
  ]
})
```

**Utilisateur avec acc√®s √† plusieurs bases :**

```javascript
use admin
db.createUser({
  user: "multi_bases",
  pwd: "motdepasse_multi",
  roles: [
    { role: "readWrite", db: "base1" },
    { role: "readWrite", db: "base2" },
    { role: "read", db: "base3" }
  ]
})
```

---

## üîß √âtape 7 : Gestion des utilisateurs

### A. Lister tous les utilisateurs

```javascript
// Se connecter en tant qu'admin
use admin

// Afficher tous les utilisateurs
db.system.users.find()

// Afficher les utilisateurs d'une base sp√©cifique
use mabase
db.getUsers()
```

### B. Modifier le mot de passe d'un utilisateur

```javascript
// Se connecter en tant qu'admin
use admin

// Changer le mot de passe de "user_mabase"
db.changeUserPassword("user_mabase", "nouveau_motdepasse_securise")
```

### C. Modifier les r√¥les d'un utilisateur

**Ajouter un r√¥le :**

```javascript
use mabase
db.grantRolesToUser("user_mabase", [
  { role: "dbAdmin", db: "mabase" }
])
```

**Retirer un r√¥le :**

```javascript
use mabase
db.revokeRolesFromUser("user_mabase", [
  { role: "dbAdmin", db: "mabase" }
])
```

### D. Supprimer un utilisateur

```javascript
use mabase
db.dropUser("user_mabase")
```

---

## üåê √âtape 8 : Format de l'URI de connexion

Pour vous connecter √† MongoDB depuis vos applications, vous utiliserez une **URI de connexion**.

### Format g√©n√©ral

```
mongodb://[username]:[password]@[host]:[port]/[database]?authSource=[auth_database]
```

### Exemples d'URI

**Utilisateur admin :**

```
mongodb://admin:motdepasse_securise_123@localhost:27017/?authSource=admin
```

**Utilisateur sur une base sp√©cifique :**

```
mongodb://user_mabase:password_user_123@localhost:27017/mabase?authSource=mabase
```

**Pour une application Node.js (exemple) :**

```javascript
const { MongoClient } = require('mongodb');

const uri = "mongodb://user_mabase:password_user_123@localhost:27017/mabase?authSource=mabase";
const client = new MongoClient(uri);

async function connecter() {
  await client.connect();
  console.log("Connect√© √† MongoDB !");
}
```

---

## üõë √âtape 9 : Gestion du conteneur

### Commandes utiles

```bash
# Voir les logs
docker-compose logs -f mongodb

# Arr√™ter MongoDB (donn√©es pr√©serv√©es)
docker-compose stop

# Red√©marrer
docker-compose start

# Voir l'√©tat
docker-compose ps
```

---

## üßπ √âtape 10 : Suppression compl√®te

**‚ö†Ô∏è ATTENTION : Ceci supprime TOUTES les donn√©es et utilisateurs !**

```bash
# 1. Arr√™ter et supprimer le conteneur
docker-compose down

# 2. Supprimer les donn√©es
rm -rf data/

# 3. Supprimer le fichier de configuration
rm docker-compose.yml
```

---

## üîê √âtape 11 : Bonnes pratiques de s√©curit√©

### ‚úÖ √Ä FAIRE

1. **Utilisez des mots de passe forts** (au moins 12 caract√®res, complexes)
2. **Cr√©ez des utilisateurs sp√©cifiques** pour chaque application/service
3. **Donnez le minimum de permissions** n√©cessaires (principe du moindre privil√®ge)
4. **Ne partagez JAMAIS** le mot de passe `root/admin`
5. **Utilisez des fichiers `.env`** pour stocker les mots de passe (voir plus bas)
6. **Changez les mots de passe r√©guli√®rement**

### ‚ùå √Ä √âVITER

1. ‚ùå Utiliser l'utilisateur `admin` dans vos applications
2. ‚ùå Mettre des mots de passe en dur dans le code source
3. ‚ùå Donner des permissions `root` √† tous les utilisateurs
4. ‚ùå Utiliser des mots de passe simples ou pr√©dictibles
5. ‚ùå Versionner les fichiers contenant des mots de passe (Git)

---

## üìÅ Bonus : Utiliser un fichier `.env` pour les mots de passe

Pour √©viter de mettre les mots de passe directement dans le `docker-compose.yml`, utilisez un fichier `.env`.

### A. Cr√©er un fichier `.env`

Dans le dossier `mongodb_avec_auth`, cr√©ez un fichier **`.env`** :

```bash
# Identifiants MongoDB
MONGO_ROOT_USERNAME=admin
MONGO_ROOT_PASSWORD=motdepasse_securise_123
```

### B. Modifier le `docker-compose.yml`

```yaml
version: '3.8'

services:
  mongodb:
    image: mongo:7.0
    container_name: mongodb_secure
    restart: unless-stopped
    environment:
      # Utilisation des variables du fichier .env
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: admin
    ports:
      - "27017:27017"
    volumes:
      - ./data:/data/db
```

### C. Ajouter `.env` au `.gitignore`

**TR√àS IMPORTANT** : Ne jamais versionner le fichier `.env` !

Cr√©ez un fichier **`.gitignore`** :

```
# Ne pas versionner les mots de passe
.env
data/
```

---

## ‚ùì Questions fr√©quentes (FAQ)

**Q : J'ai oubli√© mon mot de passe admin, que faire ?**
R : Vous devez supprimer les donn√©es et recr√©er le conteneur :
```bash
docker-compose down
rm -rf data/
docker-compose up -d
```
‚ö†Ô∏è Toutes les donn√©es seront perdues !

**Q : Comment savoir si l'authentification est activ√©e ?**
R : Essayez de vous connecter sans identifiants :
```bash
docker exec -it mongodb_secure mongosh
```
Si vous ne pouvez rien faire (erreur d'authentification), c'est activ√©.

**Q : Puis-je changer les identifiants apr√®s le premier d√©marrage ?**
R : Les variables `MONGO_INITDB_ROOT_*` ne fonctionnent qu'au **premier d√©marrage**. Pour changer ensuite, utilisez les commandes MongoDB (`db.changeUserPassword()`).

**Q : Comment donner tous les droits √† un utilisateur ?**
R : Utilisez le r√¥le `root` :
```javascript
use admin
db.createUser({
  user: "superadmin",
  pwd: "password_super",
  roles: [ "root" ]
})
```
‚ö†Ô∏è √Ä utiliser avec pr√©caution !

**Q : Mon application ne peut pas se connecter, pourquoi ?**
R : V√©rifiez :
1. Les identifiants (username/password)
2. Le nom de la base d'authentification (`authSource`)
3. Que l'utilisateur existe : `db.getUsers()`
4. Les permissions de l'utilisateur

---

## üéì Pour aller plus loin

Cette configuration avec authentification est adapt√©e pour :
- ‚úÖ D√©veloppement s√©curis√©
- ‚úÖ Environnements partag√©s
- ‚úÖ Tests d'applications r√©elles
- ‚úÖ Apprentissage des bonnes pratiques

**Prochaines √©tapes recommand√©es :**
- üëâ [5.3 Configuration avec IP fixe](03-config-ip-fixe.md)
- üëâ [5.4 MongoDB avec Mongo Express](04-mongodb-mongo-express.md)
- üëâ [Annexe D - S√©curit√© et bonnes pratiques](/annexes/D-securite-bonnes-pratiques.md)

---

## üìù R√©sum√© de ce que vous avez appris

| Concept | Ce que vous savez maintenant |
|---------|------------------------------|
| **Authentification** | Activer la s√©curit√© avec `MONGO_INITDB_ROOT_*` |
| **Utilisateurs** | Cr√©er des utilisateurs avec `db.createUser()` |
| **R√¥les** | Comprendre et attribuer les r√¥les MongoDB |
| **Connexion** | Se connecter avec identifiants (shell et URI) |
| **Gestion** | Modifier, supprimer des utilisateurs |
| **S√©curit√©** | Bonnes pratiques et fichiers `.env` |

---

## üéØ Points cl√©s √† retenir

- üîê **L'authentification est essentielle** d√®s que vous partagez votre environnement
- üë• **Cr√©ez des utilisateurs sp√©cifiques** pour chaque usage
- üõ°Ô∏è **Principe du moindre privil√®ge** : donnez uniquement les permissions n√©cessaires
- üîë **Mots de passe forts** toujours
- üìÅ **Fichiers `.env`** pour les secrets
- üö´ **Ne versionnez jamais** les mots de passe

---

## üÜò Besoin d'aide ?

Si vous rencontrez des probl√®mes :

1. **V√©rifiez les logs** : `docker-compose logs mongodb`
2. **Testez l'authentification** : `db.auth("user", "password")`
3. **V√©rifiez les utilisateurs** : `db.getUsers()`
4. **Consultez l'annexe** : [E - D√©pannage](/annexes/E-depannage.md)
5. **Documentation officielle** : [MongoDB Security](https://www.mongodb.com/docs/manual/security/)

---

üîù Retour au [Sommaire](/SOMMAIRE.md)
