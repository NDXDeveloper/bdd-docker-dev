# 5.3 - Configuration de MongoDB avec IP fixe

üîù Retour au [Sommaire](/SOMMAIRE.md)

---

## üìã Introduction

Dans les fiches pr√©c√©dentes, nous avons mis en place MongoDB de mani√®re basique ([5.1](01-config-basique-docker-compose.md)) puis avec authentification ([5.2](02-config-avec-authentification.md)). Ces configurations fonctionnent tr√®s bien, mais **l'adresse IP du conteneur MongoDB change √† chaque red√©marrage**.

### ü§î Pourquoi c'est un probl√®me ?

**Sans IP fixe :**
```
Premier d√©marrage  ‚Üí MongoDB a l'IP 172.17.0.2
Red√©marrage        ‚Üí MongoDB a l'IP 172.17.0.5  ‚ùå Chang√© !
```

**Cons√©quences :**
- ‚ùå Vos applications qui utilisent l'IP directement ne fonctionnent plus
- ‚ùå Configurations r√©seau complexes difficiles √† maintenir
- ‚ùå Communication entre conteneurs impr√©visible

**Avec IP fixe :**
```
Premier d√©marrage  ‚Üí MongoDB a l'IP 172.18.0.10
Red√©marrage        ‚Üí MongoDB a l'IP 172.18.0.10  ‚úÖ Stable !
Toujours pareil    ‚Üí MongoDB a l'IP 172.18.0.10  ‚úÖ Pr√©visible !
```

Dans cette fiche, nous allons cr√©er un **r√©seau Docker personnalis√©** et assigner une **adresse IP fixe** √† notre conteneur MongoDB.

---

## üéØ Objectifs de cette fiche

√Ä la fin de ce tutoriel, vous saurez :

- ‚úÖ Cr√©er un r√©seau Docker personnalis√© avec une plage d'adresses IP
- ‚úÖ Assigner une IP fixe √† votre conteneur MongoDB
- ‚úÖ Comprendre les concepts de r√©seau Docker
- ‚úÖ Connecter d'autres conteneurs sur le m√™me r√©seau
- ‚úÖ Nettoyer proprement les r√©seaux Docker

---

## üõ†Ô∏è Pr√©requis

Avant de commencer :

- **Docker** et **Docker Compose** install√©s
- Avoir suivi les fiches [5.1](01-config-basique-docker-compose.md) et [5.2](02-config-avec-authentification.md) (recommand√©)
- Comprendre les bases des r√©seaux (notion d'adresse IP)

---

## üß† √âtape 1 : Comprendre les r√©seaux Docker

### A. Qu'est-ce qu'un r√©seau Docker ?

Un **r√©seau Docker** est comme un r√©seau local virtuel o√π vos conteneurs peuvent communiquer entre eux. Par d√©faut, Docker cr√©e un r√©seau automatique, mais il ne permet pas d'assigner des IP fixes.

### B. Types de r√©seaux Docker

| Type | Description | Utilisation |
|------|-------------|-------------|
| **bridge** (par d√©faut) | R√©seau isol√© sur l'h√¥te | Conteneurs sur la m√™me machine |
| **host** | Utilise le r√©seau de l'h√¥te | Performances maximales |
| **none** | Aucun r√©seau | Conteneurs isol√©s |
| **bridge personnalis√©** | R√©seau avec configuration custom | **IP fixes, DNS personnalis√©** ‚úÖ |

Nous allons utiliser un **bridge personnalis√©** pour avoir le contr√¥le sur les adresses IP.

### C. Notion de sous-r√©seau (subnet)

Un sous-r√©seau d√©finit une **plage d'adresses IP disponibles**.

**Exemple :**
```
Subnet : 172.18.0.0/16
Signifie : de 172.18.0.1 √† 172.18.255.254
         ‚âà 65 000 adresses disponibles
```

**Analogie :** C'est comme un immeuble avec 65 000 appartements num√©rot√©s. Nous allons r√©server l'appartement n¬∞10 pour MongoDB.

---

## üì° √âtape 2 : Cr√©ation du r√©seau Docker personnalis√©

### A. Cr√©er le r√©seau

Ouvrez un terminal et ex√©cutez cette commande **une seule fois** :

```bash
docker network create --subnet=172.18.0.0/16 mongodb_net
```

**Explication de la commande :**

| √âl√©ment | Signification |
|---------|---------------|
| `docker network create` | Commande pour cr√©er un r√©seau |
| `--subnet=172.18.0.0/16` | D√©finit la plage d'IP (de 172.18.0.1 √† 172.18.255.254) |
| `mongodb_net` | Nom du r√©seau (vous pouvez le changer) |

**Sortie attendue :**

```
f8a3b2c1d4e5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1
```

C'est l'identifiant unique du r√©seau cr√©√©.

### B. V√©rifier la cr√©ation du r√©seau

```bash
docker network ls
```

**R√©sultat attendu :**

```
NETWORK ID     NAME          DRIVER    SCOPE
abc123def456   bridge        bridge    local
def789ghi012   mongodb_net   bridge    local     ‚Üê Notre r√©seau !
```

### C. Inspecter le r√©seau

Pour voir les d√©tails du r√©seau :

```bash
docker network inspect mongodb_net
```

Vous verrez des informations d√©taill√©es, notamment :

```json
"Subnet": "172.18.0.0/16",
"Gateway": "172.18.0.1"
```

---

## üìÅ √âtape 3 : Pr√©paration de l'environnement

### Cr√©er un nouveau dossier de projet

```bash
# Cr√©er le dossier
mkdir mongodb_ip_fixe

# Se d√©placer dedans
cd mongodb_ip_fixe

# Cr√©er le dossier pour les donn√©es
mkdir data
```

---

## üìÑ √âtape 4 : Configuration du `docker-compose.yml`

Cr√©ez un fichier **`docker-compose.yml`** avec le contenu suivant :

```yaml
version: '3.8'

services:
  mongodb:
    # Image officielle MongoDB
    image: mongo:7.0

    # Nom du conteneur
    container_name: mongodb_fixed_ip

    # Red√©marre automatiquement
    restart: unless-stopped

    # Authentification (optionnel mais recommand√©)
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: motdepasse_securise_123

    # Port pour acc√©der depuis l'h√¥te
    ports:
      - "27017:27017"

    # Volume pour la persistance
    volumes:
      - ./data:/data/db

    # ‚≠ê NOUVEAUT√â : Configuration r√©seau avec IP fixe
    networks:
      mongodb_net:
        ipv4_address: 172.18.0.10

# ‚≠ê NOUVEAUT√â : D√©claration du r√©seau externe
networks:
  mongodb_net:
    external: true
```

### üìñ Explication des nouveaut√©s

| Section | Explication |
|---------|-------------|
| `networks:` (dans le service) | Configure le r√©seau pour ce conteneur |
| `mongodb_net:` | Nom du r√©seau √† utiliser |
| `ipv4_address: 172.18.0.10` | **IP FIXE assign√©e au conteneur** |
| `networks:` (en bas) | D√©claration globale des r√©seaux |
| `external: true` | Indique que le r√©seau existe d√©j√† (cr√©√© √† l'√©tape 2) |

### üé® Pourquoi 172.18.0.10 ?

Vous pouvez choisir n'importe quelle IP dans la plage `172.18.0.1` √† `172.18.255.254`, **sauf** :
- ‚ùå `172.18.0.1` (r√©serv√©e pour la passerelle/gateway)
- ‚ùå `172.18.0.0` (adresse du r√©seau)
- ‚ùå `172.18.255.255` (adresse de broadcast)

**Bonnes pratiques :**
- ‚úÖ Utilisez des IP basses (`172.18.0.10`, `172.18.0.11`, etc.) pour faciliter la m√©morisation
- ‚úÖ Documentez vos IP (notez quel conteneur a quelle IP)
- ‚úÖ Laissez de l'espace entre chaque IP (10, 20, 30...) pour ajouter des services plus tard

---

## ‚ñ∂Ô∏è √âtape 5 : D√©marrage de MongoDB avec IP fixe

Lancez MongoDB :

```bash
docker-compose up -d
```

**Sortie attendue :**

```
Creating mongodb_fixed_ip ... done
```

### ‚úÖ V√©rification du d√©marrage

```bash
docker-compose ps
```

---

## üîç √âtape 6 : V√©rification de l'IP fixe

### A. M√©thode 1 : Avec `docker inspect`

```bash
docker inspect mongodb_fixed_ip | grep IPAddress
```

**R√©sultat attendu :**

```json
"IPAddress": "",
"SecondaryIPAddresses": null,
"IPAddress": "172.18.0.10",    ‚Üê Notre IP fixe !
```

### B. M√©thode 2 : Inspection compl√®te du r√©seau

```bash
docker network inspect mongodb_net
```

Cherchez la section `Containers`, vous verrez :

```json
"Containers": {
    "abc123...": {
        "Name": "mongodb_fixed_ip",
        "IPv4Address": "172.18.0.10/16",    ‚Üê Confirm√© !
        ...
    }
}
```

### C. Test de persistance de l'IP

**Red√©marrez le conteneur plusieurs fois :**

```bash
# Test 1 : Red√©marrage simple
docker-compose restart
docker inspect mongodb_fixed_ip | grep "IPAddress"

# Test 2 : Arr√™t et red√©marrage
docker-compose stop
docker-compose start
docker inspect mongodb_fixed_ip | grep "IPAddress"

# Test 3 : Suppression et recr√©ation
docker-compose down
docker-compose up -d
docker inspect mongodb_fixed_ip | grep "IPAddress"
```

**√Ä chaque fois, vous devriez voir : `"IPAddress": "172.18.0.10"` ‚úÖ**

---

## üîó √âtape 7 : Connexion √† MongoDB via l'IP fixe

### A. Depuis le shell MongoDB

**Via localhost (depuis votre machine) :**

```bash
docker exec -it mongodb_fixed_ip mongosh -u admin -p motdepasse_securise_123 --authenticationDatabase admin
```

**Via l'IP fixe (depuis un autre conteneur du m√™me r√©seau) :**

Nous allons cr√©er un conteneur temporaire pour tester :

```bash
# Cr√©er un conteneur Ubuntu connect√© au m√™me r√©seau
docker run -it --rm --network mongodb_net ubuntu bash

# Une fois dans le conteneur Ubuntu, installer mongosh
apt-get update && apt-get install -y wget gnupg
wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/7.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-7.0.list
apt-get update && apt-get install -y mongodb-mongosh

# Se connecter via l'IP fixe
mongosh mongodb://admin:motdepasse_securise_123@172.18.0.10:27017/?authSource=admin
```

‚úÖ Si la connexion fonctionne, votre IP fixe est bien configur√©e !

### B. Depuis MongoDB Compass

**URI de connexion avec IP fixe :**

```
mongodb://admin:motdepasse_securise_123@172.18.0.10:27017/?authSource=admin
```

**Ou via localhost (fonctionne toujours) :**

```
mongodb://admin:motdepasse_securise_123@localhost:27017/?authSource=admin
```

Les deux fonctionnent ! La diff√©rence :
- `localhost` : Connexion depuis votre machine via le port expos√© (27017)
- `172.18.0.10` : Connexion directe via le r√©seau Docker (utile pour d'autres conteneurs)

---

## üåê √âtape 8 : Ajouter d'autres services sur le m√™me r√©seau

L'int√©r√™t principal d'un r√©seau personnalis√© est de connecter **plusieurs conteneurs** entre eux.

### Exemple : Ajouter une application Node.js

Modifiez votre `docker-compose.yml` :

```yaml
version: '3.8'

services:
  mongodb:
    image: mongo:7.0
    container_name: mongodb_fixed_ip
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: motdepasse_securise_123
    ports:
      - "27017:27017"
    volumes:
      - ./data:/data/db
    networks:
      mongodb_net:
        ipv4_address: 172.18.0.10

  # ‚≠ê NOUVEAU SERVICE : Application Node.js
  app:
    image: node:18
    container_name: node_app
    restart: unless-stopped
    working_dir: /app
    command: node server.js
    ports:
      - "3000:3000"
    volumes:
      - ./app:/app
    networks:
      mongodb_net:
        ipv4_address: 172.18.0.20    # Autre IP fixe
    # Variable d'environnement avec l'IP de MongoDB
    environment:
      - MONGO_URL=mongodb://admin:motdepasse_securise_123@172.18.0.10:27017/?authSource=admin

networks:
  mongodb_net:
    external: true
```

**Avantages :**
- ‚úÖ L'application Node.js conna√Æt toujours l'adresse de MongoDB (`172.18.0.10`)
- ‚úÖ Pas de probl√®me si un conteneur red√©marre
- ‚úÖ Communication rapide et directe entre conteneurs

---

## üìä √âtape 9 : Tableau r√©capitulatif des adresses

| Service | Nom du conteneur | IP fixe | Port | Accessible depuis |
|---------|------------------|---------|------|-------------------|
| MongoDB | `mongodb_fixed_ip` | `172.18.0.10` | 27017 | R√©seau `mongodb_net` |
| MongoDB (port expos√©) | - | `localhost` | 27017 | Votre machine |
| Application (exemple) | `node_app` | `172.18.0.20` | 3000 | R√©seau `mongodb_net` |

---

## üõë √âtape 10 : Gestion et nettoyage

### A. Arr√™ter les conteneurs (garder le r√©seau)

```bash
# Arr√™ter les conteneurs
docker-compose stop

# Red√©marrer
docker-compose start
```

Le r√©seau `mongodb_net` reste intact.

### B. Supprimer les conteneurs (garder le r√©seau)

```bash
# Supprimer les conteneurs mais pas le r√©seau
docker-compose down
```

Le r√©seau `mongodb_net` existe toujours (car marqu√© comme `external: true`).

### C. Suppression compl√®te (conteneurs + r√©seau)

**‚ö†Ô∏è ATTENTION : Toutes les donn√©es et la configuration r√©seau seront perdues !**

```bash
# 1. Arr√™ter et supprimer les conteneurs
docker-compose down

# 2. Supprimer les donn√©es
rm -rf data/

# 3. Supprimer le r√©seau personnalis√©
docker network rm mongodb_net

# 4. (Optionnel) Supprimer les fichiers de configuration
rm docker-compose.yml
```

### D. V√©rifier les r√©seaux existants

```bash
# Lister tous les r√©seaux
docker network ls

# Voir les d√©tails d'un r√©seau
docker network inspect mongodb_net

# Supprimer un r√©seau (si aucun conteneur ne l'utilise)
docker network rm mongodb_net
```

---

## üßπ √âtape 11 : Nettoyage des r√©seaux inutilis√©s

Avec le temps, des r√©seaux inutilis√©s peuvent s'accumuler.

### A. Voir les r√©seaux non utilis√©s

```bash
docker network ls --filter "dangling=true"
```

### B. Supprimer tous les r√©seaux non utilis√©s

```bash
docker network prune
```

**Confirmation demand√©e :**

```
WARNING! This will remove all custom networks not used by at least one container.
Are you sure you want to continue? [y/N] y
```

**Cette commande ne supprimera PAS :**
- Les r√©seaux actuellement utilis√©s par des conteneurs
- Les r√©seaux par d√©faut (`bridge`, `host`, `none`)

---

## ‚ùì Questions fr√©quentes (FAQ)

**Q : Puis-je utiliser n'importe quelle plage d'IP ?**
R : Oui, mais il est recommand√© d'utiliser des plages priv√©es :
- `172.16.0.0/12` (de 172.16.0.0 √† 172.31.255.255)
- `192.168.0.0/16` (de 192.168.0.0 √† 192.168.255.255)
- `10.0.0.0/8` (de 10.0.0.0 √† 10.255.255.255)

**Q : Que se passe-t-il si j'assigne la m√™me IP √† deux conteneurs ?**
R : Docker refusera de d√©marrer le second conteneur avec une erreur :
```
Error response from daemon: Address already in use
```

**Q : Puis-je changer l'IP d'un conteneur en cours d'ex√©cution ?**
R : Non, vous devez :
1. Arr√™ter le conteneur : `docker-compose down`
2. Modifier l'IP dans `docker-compose.yml`
3. Red√©marrer : `docker-compose up -d`

**Q : Mon r√©seau entre en conflit avec mon r√©seau local, que faire ?**
R : Choisissez une autre plage d'IP. Par exemple :
- Si votre r√©seau local est `192.168.1.x`, utilisez `172.18.0.0/16`
- Si vous avez d√©j√† `172.18.x.x`, utilisez `172.19.0.0/16`

**Q : Puis-je connecter un conteneur √† plusieurs r√©seaux ?**
R : Oui ! Exemple :
```yaml
networks:
  mongodb_net:
    ipv4_address: 172.18.0.10
  autre_reseau:
    ipv4_address: 192.168.50.10
```

**Q : Est-ce que l'IP fixe fonctionne avec `docker run` ?**
R : Oui, mais c'est plus complexe :
```bash
docker run -d \
  --name mongodb_fixed_ip \
  --network mongodb_net \
  --ip 172.18.0.10 \
  -p 27017:27017 \
  -v $(pwd)/data:/data/db \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=motdepasse_securise_123 \
  mongo:7.0
```
Docker Compose est **beaucoup plus simple** ! üòä

---

## üéì Pour aller plus loin

Cette configuration avec IP fixe est id√©ale pour :
- ‚úÖ Architectures multi-conteneurs stables
- ‚úÖ D√©veloppement d'applications microservices
- ‚úÖ Tests d'int√©gration avec plusieurs services
- ‚úÖ Environnements o√π la pr√©visibilit√© est importante

**Prochaines √©tapes recommand√©es :**
- üëâ [5.4 MongoDB avec Mongo Express](04-mongodb-mongo-express.md)
- üëâ [5.5 Replica Set simple](05-replica-set-simple.md)
- üëâ [Annexe B - Gestion des r√©seaux Docker](/annexes/B-gestion-reseaux.md)
- üëâ [Cas pratique 02 - Stack MEAN](/cas-pratiques/02-stack-mean.md)

---

## üìù R√©sum√© de ce que vous avez appris

| Concept | Ce que vous savez maintenant |
|---------|------------------------------|
| **R√©seaux Docker** | Cr√©er un r√©seau personnalis√© avec `docker network create` |
| **Sous-r√©seau** | D√©finir une plage d'IP avec `--subnet` |
| **IP fixe** | Assigner une IP statique avec `ipv4_address` |
| **R√©seau externe** | Utiliser un r√©seau existant avec `external: true` |
| **Multi-conteneurs** | Connecter plusieurs services sur le m√™me r√©seau |
| **Nettoyage** | Supprimer proprement les r√©seaux Docker |

---

## üéØ Points cl√©s √† retenir

- üåê **Un r√©seau personnalis√©** permet d'assigner des IP fixes
- üìå **IP fixe = pr√©visibilit√©** pour vos architectures multi-conteneurs
- üîó **Communication inter-conteneurs** simplifi√©e
- üìä **Documentez vos IP** pour √©viter les conflits
- üßπ **Nettoyez r√©guli√®rement** les r√©seaux inutilis√©s
- ‚öôÔ∏è **Docker Compose simplifie** la gestion des r√©seaux

---

## üîß Commandes essentielles √† retenir

```bash
# Cr√©er un r√©seau
docker network create --subnet=172.18.0.0/16 mongodb_net

# Lister les r√©seaux
docker network ls

# Inspecter un r√©seau
docker network inspect mongodb_net

# V√©rifier l'IP d'un conteneur
docker inspect <conteneur> | grep IPAddress

# Supprimer un r√©seau
docker network rm mongodb_net

# Nettoyer les r√©seaux inutilis√©s
docker network prune
```

---

## üÜò Besoin d'aide ?

Si vous rencontrez des probl√®mes :

1. **V√©rifiez que le r√©seau existe** : `docker network ls`
2. **Inspectez le r√©seau** : `docker network inspect mongodb_net`
3. **V√©rifiez les conflits d'IP** : Aucun autre conteneur ne doit utiliser `172.18.0.10`
4. **Consultez les logs** : `docker-compose logs mongodb`
5. **Annexe** : [B - Gestion des r√©seaux](/annexes/B-gestion-reseaux.md)
6. **Documentation Docker** : [Docker Networks](https://docs.docker.com/network/)

---

üîù Retour au [Sommaire](/SOMMAIRE.md)
