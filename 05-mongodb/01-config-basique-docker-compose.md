# 5.1 - Configuration basique de MongoDB avec docker-compose

üîù Retour au [Sommaire](/SOMMAIRE.md)

---

## üìã Introduction

**MongoDB** est une base de donn√©es NoSQL orient√©e documents, tr√®s populaire pour les applications web modernes. Contrairement aux bases de donn√©es relationnelles (SQL), MongoDB stocke les donn√©es sous forme de documents JSON flexibles, ce qui facilite le d√©veloppement rapide et l'adaptation aux changements de structure.

Dans cette fiche, nous allons mettre en place une instance MongoDB simple avec Docker, sans authentification (id√©al pour d√©buter et faire des tests en local).

---

## üéØ Objectifs de cette fiche

√Ä la fin de ce tutoriel, vous saurez :

- ‚úÖ D√©marrer une instance MongoDB avec `docker-compose`
- ‚úÖ Acc√©der √† MongoDB depuis votre machine (client GUI ou ligne de commande)
- ‚úÖ Persister vos donn√©es m√™me apr√®s suppression du conteneur
- ‚úÖ G√©rer le cycle de vie du conteneur (d√©marrage, arr√™t, suppression)

---

## üõ†Ô∏è Pr√©requis

Avant de commencer, assurez-vous d'avoir :

- **Docker** install√© sur votre machine
- **Docker Compose** (g√©n√©ralement inclus avec Docker Desktop)
- Un √©diteur de texte (VS Code, Notepad++, nano, vim...)
- Des notions de base sur le terminal/ligne de commande

**V√©rification rapide :**

```bash
# V√©rifier Docker
docker --version

# V√©rifier Docker Compose
docker-compose --version
```

---

## üìÅ √âtape 1 : Pr√©paration de l'environnement

### A. Cr√©er un dossier pour le projet

Cr√©ez un nouveau dossier pour organiser votre configuration MongoDB :

```bash
# Cr√©er le dossier
mkdir mongodb_basique

# Se d√©placer dedans
cd mongodb_basique
```

### B. Cr√©er le dossier de donn√©es

MongoDB aura besoin d'un endroit pour stocker ses donn√©es de mani√®re persistante :

```bash
# Cr√©er le dossier data
mkdir data
```

Votre structure ressemble maintenant √† ceci :

```
mongodb_basique/
‚îî‚îÄ‚îÄ data/          (vide pour l'instant)
```

---

## üìÑ √âtape 2 : Cr√©ation du fichier `docker-compose.yml`

Dans le dossier `mongodb_basique`, cr√©ez un fichier nomm√© **`docker-compose.yml`** avec le contenu suivant :

```yaml
version: '3.8'

services:
  mongodb:
    # Image officielle MongoDB (version 7.0)
    image: mongo:7.0

    # Nom du conteneur (facilite les commandes docker)
    container_name: mongodb_dev

    # Red√©marre automatiquement le conteneur sauf si arr√™t√© manuellement
    restart: unless-stopped

    # Port pour acc√©der √† MongoDB depuis votre machine
    # Format : "port_h√¥te:port_conteneur"
    ports:
      - "27017:27017"

    # Volume pour la persistance des donn√©es
    # Les donn√©es seront stock√©es dans le dossier ./data
    volumes:
      - ./data:/data/db
```

### üìñ Explication ligne par ligne

| Ligne | Signification |
|-------|---------------|
| `version: '3.8'` | Version du format docker-compose utilis√© |
| `services:` | D√©but de la liste des services (conteneurs) |
| `mongodb:` | Nom du service (vous pouvez le changer) |
| `image: mongo:7.0` | Image Docker officielle de MongoDB version 7.0 |
| `container_name: mongodb_dev` | Nom du conteneur cr√©√© (facilite son identification) |
| `restart: unless-stopped` | Red√©marre automatiquement si le syst√®me reboot |
| `ports: - "27017:27017"` | Expose le port 27017 de MongoDB sur votre machine |
| `volumes: - ./data:/data/db` | Les donn√©es sont sauvegard√©es dans le dossier `./data` |

---

## ‚ñ∂Ô∏è √âtape 3 : D√©marrage de MongoDB

Maintenant que tout est pr√™t, lancez MongoDB avec une seule commande :

```bash
docker-compose up -d
```

**Que fait cette commande ?**

- `docker-compose` : Outil pour g√©rer plusieurs conteneurs
- `up` : D√©marre les services d√©finis dans le fichier
- `-d` : Mode "detached" (arri√®re-plan), le terminal reste libre

**Sortie attendue :**

```
Creating network "mongodb_basique_default" with the default driver
Creating mongodb_dev ... done
```

### ‚úÖ V√©rification du d√©marrage

V√©rifiez que le conteneur fonctionne bien :

```bash
docker-compose ps
```

Vous devriez voir quelque chose comme :

```
    Name                  Command             State            Ports
-------------------------------------------------------------------------------
mongodb_dev   docker-entrypoint.sh mongod   Up      0.0.0.0:27017->27017/tcp
```

Le statut **"Up"** confirme que MongoDB est en cours d'ex√©cution.

---

## üîç √âtape 4 : Acc√©der √† MongoDB

### A. Depuis le shell MongoDB (ligne de commande)

Pour vous connecter directement au shell MongoDB √† l'int√©rieur du conteneur :

```bash
docker exec -it mongodb_dev mongosh
```

**Explication :**
- `docker exec` : Ex√©cute une commande dans un conteneur en cours
- `-it` : Mode interactif avec terminal
- `mongodb_dev` : Nom de notre conteneur
- `mongosh` : Shell MongoDB (remplace l'ancien `mongo`)

**Une fois connect√©, vous verrez :**

```
Current Mongosh Log ID:	...
Connecting to:		mongodb://127.0.0.1:27017
Using MongoDB:		7.0.x
Using Mongosh:		2.x.x

test>
```

### B. Commandes MongoDB de base

Une fois dans le shell, vous pouvez tester quelques commandes :

```javascript
// Afficher les bases de donn√©es existantes
show dbs

// Cr√©er/utiliser une base de donn√©es "mabase"
use mabase

// Ins√©rer un document dans la collection "users"
db.users.insertOne({ nom: "Dupont", prenom: "Jean", age: 30 })

// Afficher tous les documents de la collection
db.users.find()

// Quitter le shell
exit
```

### C. Depuis un client graphique

Vous pouvez √©galement utiliser des outils graphiques pour vous connecter √† MongoDB :

**Clients recommand√©s :**
- **MongoDB Compass** (officiel, gratuit) : [T√©l√©charger ici](https://www.mongodb.com/products/compass)
- **NoSQLBooster** (anciennement MongoBooster)
- **Robo 3T** (Studio 3T)

**Param√®tres de connexion :**

| Param√®tre | Valeur |
|-----------|--------|
| **H√¥te** | `localhost` ou `127.0.0.1` |
| **Port** | `27017` |
| **Authentification** | Aucune (mode basique) |

---

## üìä √âtape 5 : V√©rification de la persistance des donn√©es

L'un des avantages de notre configuration est que les donn√©es survivent √† l'arr√™t du conteneur.

### Test de persistance

1. **Ins√©rez des donn√©es** (via le shell ou un client GUI)

```bash
docker exec -it mongodb_dev mongosh
```

```javascript
use testpersistence
db.documents.insertOne({ message: "Ces donn√©es doivent persister" })
db.documents.find()
exit
```

2. **Arr√™tez le conteneur**

```bash
docker-compose stop
```

3. **V√©rifiez que le dossier `data` contient des fichiers**

```bash
ls -la data/
```

Vous devriez voir des fichiers MongoDB (`.wt`, `WiredTiger.*`, etc.)

4. **Red√©marrez le conteneur**

```bash
docker-compose start
```

5. **Reconnectez-vous et v√©rifiez vos donn√©es**

```bash
docker exec -it mongodb_dev mongosh
```

```javascript
use testpersistence
db.documents.find()
```

Vos donn√©es sont toujours l√† ! üéâ

---

## üõë √âtape 6 : Gestion du conteneur

### Commandes utiles

```bash
# Voir les logs en temps r√©el
docker-compose logs -f

# Arr√™ter MongoDB (donn√©es pr√©serv√©es)
docker-compose stop

# Red√©marrer MongoDB
docker-compose start

# Red√©marrer compl√®tement (stop + start)
docker-compose restart

# Voir l'√©tat du conteneur
docker-compose ps

# Voir les statistiques de ressources (CPU, RAM)
docker stats mongodb_dev
```

---

## üßπ √âtape 7 : Suppression compl√®te (nettoyage)

Si vous souhaitez tout supprimer (conteneur + donn√©es), suivez ces √©tapes :

### A. Arr√™ter et supprimer le conteneur

```bash
# Arr√™te et supprime le conteneur (mais pas les donn√©es)
docker-compose down
```

### B. Supprimer les donn√©es

**‚ö†Ô∏è ATTENTION : Cette action est irr√©versible !**

```bash
# Supprime le dossier contenant toutes les donn√©es MongoDB
rm -rf data/

# Sur Windows (PowerShell)
Remove-Item -Recurse -Force data
```

### C. Supprimer les fichiers de configuration

Si vous voulez √©galement supprimer le fichier de configuration :

```bash
# Supprimer le fichier docker-compose.yml
rm docker-compose.yml
```

---

## üéì Pour aller plus loin

Cette configuration basique est parfaite pour :
- ‚úÖ Apprendre MongoDB
- ‚úÖ D√©veloppement en local
- ‚úÖ Tests rapides
- ‚úÖ Prototypes

**Mais elle n'est PAS adapt√©e pour :**
- ‚ùå Production (pas de s√©curit√©)
- ‚ùå Acc√®s depuis d'autres machines (pas d'authentification)
- ‚ùå Environnements multi-utilisateurs

**Prochaines √©tapes recommand√©es :**
- üëâ [5.2 Configuration avec authentification](02-config-avec-authentification.md)
- üëâ [5.3 Configuration avec IP fixe](03-config-ip-fixe.md)
- üëâ [5.4 MongoDB avec Mongo Express (interface web)](04-mongodb-mongo-express.md)

---

## üìù R√©sum√© de ce que vous avez appris

| Concept | Ce que vous savez maintenant |
|---------|------------------------------|
| **Docker Compose** | G√©rer MongoDB avec un simple fichier YAML |
| **Volumes** | Persister les donn√©es avec `./data:/data/db` |
| **Ports** | Exposer MongoDB sur `localhost:27017` |
| **Shell MongoDB** | Se connecter avec `docker exec -it mongodb_dev mongosh` |
| **Cycle de vie** | D√©marrer, arr√™ter, supprimer proprement |

---

## ‚ùì Questions fr√©quentes (FAQ)

**Q : Puis-je changer le port 27017 ?**
R : Oui ! Modifiez la ligne `ports:` dans le `docker-compose.yml` :
```yaml
ports:
  - "27018:27017"  # MongoDB accessible sur le port 27018 de votre machine
```

**Q : Comment mettre √† jour la version de MongoDB ?**
R : Changez `image: mongo:7.0` en `image: mongo:8.0` (ou la version souhait√©e) puis :
```bash
docker-compose down
docker-compose up -d
```

**Q : Mes donn√©es prennent beaucoup de place, comment les r√©duire ?**
R : MongoDB utilise beaucoup d'espace pour la performance. Vous pouvez :
- Supprimer les bases de test inutiles
- Utiliser `db.collection.drop()` pour supprimer des collections
- Compacter la base : `db.runCommand({ compact: 'nom_collection' })`

**Q : MongoDB refuse de d√©marrer, que faire ?**
R : Consultez les logs pour voir l'erreur :
```bash
docker-compose logs mongodb
```
Les erreurs courantes : port d√©j√† utilis√©, permissions sur le dossier `data/`

**Q : Comment sauvegarder ma base de donn√©es ?**
R : Utilisez `mongodump` :
```bash
docker exec mongodb_dev mongodump --out=/data/backup
```
Le backup sera dans `./data/backup/` sur votre machine.

---

## üéØ Points cl√©s √† retenir

- üê≥ **Docker facilite l'installation** : Pas besoin d'installer MongoDB sur votre syst√®me
- üíæ **Les volumes assurent la persistance** : Vos donn√©es survivent aux red√©marrages
- üîß **docker-compose simplifie la gestion** : Une commande pour tout contr√¥ler
- üöÄ **Configuration basique = d√©marrage rapide** : Parfait pour apprendre et tester
- üîí **Pas de s√©curit√© = pas pour la production** : Toujours ajouter l'authentification en environnement r√©el

---

## üÜò Besoin d'aide ?

Si vous rencontrez des probl√®mes :

1. **V√©rifiez les logs** : `docker-compose logs mongodb`
2. **Consultez l'annexe** : [E - D√©pannage](/annexes/E-depannage.md)
3. **Documentation officielle** : [MongoDB Docker Hub](https://hub.docker.com/_/mongo)
4. **Red√©marrez proprement** :
   ```bash
   docker-compose down
   docker-compose up -d
   ```

---

üîù Retour au [Sommaire](/SOMMAIRE.md)
